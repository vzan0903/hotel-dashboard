<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <title>é…’åº—ä»·æ ¼æŒ‡æŒ¥ä¸­å¿ƒ V23.0 (è‡ªé€‚åº”èˆ’çœ¼ç‰ˆ)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="data.js"></script>
    <style>
        /* === æ ¸å¿ƒï¼šCSS å˜é‡å®šä¹‰ (ä¸»é¢˜ç³»ç»Ÿ) === */
        :root {
            /* === é»˜è®¤ï¼šæµ…è‰²æ¨¡å¼ (Light Mode) === */
            --bg-body: #f0f2f5;           /* æ•´ä½“èƒŒæ™¯ï¼šæµ…ç° */
            --bg-nav: #ffffff;            /* å¯¼èˆªæ ï¼šç™½ */
            --bg-panel: #ffffff;          /* é¢æ¿èƒŒæ™¯ï¼šç™½ */
            --bg-element: #f8fafc;        /* å°å…ƒç´ èƒŒæ™¯ */
            
            --text-main: #1f2937;         /* ä¸»æ–‡å­—ï¼šæ·±é»‘ */
            --text-sub: #6b7280;          /* æ¬¡è¦æ–‡å­—ï¼šç° */
            --text-accent: #3b82f6;       /* å¼ºè°ƒè‰²ï¼šè“ */
            
            --border-color: #e5e7eb;      /* è¾¹æ¡†ï¼šæµ…ç° */
            --border-hover: #9ca3af;
            
            --chart-split: #e5e7eb;       /* å›¾è¡¨ç½‘æ ¼çº¿ */
            --chart-axis: #6b7280;        /* å›¾è¡¨æ–‡å­— */
            
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* === æ·±è‰²æ¨¡å¼ (Dark Mode) - ä¼˜åŒ–åçš„èˆ’çœ¼æ·±è‰² === */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-body: #131720;       /* æ•´ä½“èƒŒæ™¯ï¼šä¸å†æ˜¯æ­»é»‘ï¼Œè€Œæ˜¯æ·±è“ç° */
                --bg-nav: #1b212d;        /* å¯¼èˆªæ  */
                --bg-panel: #1b212d;      /* é¢æ¿èƒŒæ™¯ */
                --bg-element: #252b3b;    /* å°å…ƒç´ èƒŒæ™¯ */
                
                --text-main: #e2e8f0;     /* ä¸»æ–‡å­—ï¼šæŸ”å’Œç™½ */
                --text-sub: #94a3b8;      /* æ¬¡è¦æ–‡å­—ï¼šè“ç° */
                --text-accent: #60a5fa;   /* å¼ºè°ƒè‰²ï¼šäº®è“ */
                
                --border-color: #2d3748;  /* è¾¹æ¡†ï¼šæ·±ç° */
                --border-hover: #4b5563;
                
                --chart-split: #2d3748;   /* å›¾è¡¨ç½‘æ ¼çº¿ */
                --chart-axis: #94a3b8;    /* å›¾è¡¨æ–‡å­— */
                
                --shadow: 0 4px 6px rgba(0,0,0,0.3);
            }
        }

        /* === åŸºç¡€å¸ƒå±€ === */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: var(--bg-body); color: var(--text-main); font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif; overflow: hidden; transition: background-color 0.3s, color 0.3s; }
        
        /* é¡¶éƒ¨å¯¼èˆª */
        .nav-bar { height: 50px; background: var(--bg-nav); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; padding: 0 20px; justify-content: space-between; flex-shrink: 0; z-index: 100; position: relative; box-shadow: var(--shadow); }
        .nav-left { display: flex; align-items: center; gap: 30px; }
        .app-title { font-size: 18px; font-weight: bold; color: var(--text-main); display:flex; align-items:center; letter-spacing: 1px; }
        .live-dot { width: 8px; height: 8px; background: #10b981; border-radius: 50%; margin-right: 10px; box-shadow: 0 0 10px #10b981; animation: blink 2s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        .view-tabs { display: flex; background: var(--bg-element); border-radius: 6px; border: 1px solid var(--border-color); padding: 3px; }
        .view-tab { padding: 5px 15px; cursor: pointer; font-size: 13px; color: var(--text-sub); transition: all 0.2s; border-radius: 4px; font-weight: 500; }
        .view-tab.active { background: var(--bg-panel); color: var(--text-main); font-weight: bold; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        
        .bed-select { background: var(--bg-element); color: var(--text-main); border: 1px solid var(--border-color); padding: 5px 12px; border-radius: 6px; margin-left: auto; outline:none; font-size: 13px;}

        /* ä¸»è§†å›¾å®¹å™¨ */
        .main-content { position: relative; width: 100%; height: calc(100% - 50px); }
        .view-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); display: flex; flex-direction: column; z-index: 1; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .view-layer.active { z-index: 10; opacity: 1; pointer-events: auto; }

        /* è§†å›¾ç»„ä»¶ */
        .date-ribbon-wrapper { height: 45px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; background: var(--bg-nav); flex-shrink: 0; }
        .date-scroll { display: flex; overflow-x: auto; gap: 6px; width: 100%; padding: 0 10px; scroll-behavior: smooth; -ms-overflow-style: none; scrollbar-width: none; }
        .date-scroll::-webkit-scrollbar { display: none; }
        .date-chip { min-width: 85px; height: 34px; background: var(--bg-element); border: 1px solid var(--border-color); border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; transition: all 0.2s; }
        .date-chip:hover { border-color: var(--border-hover); }
        .date-chip.active { background: var(--bg-panel); border: 1px solid var(--text-accent); box-shadow: 0 0 0 1px var(--text-accent) inset; }
        .date-chip.weekend { border-top: 3px solid #fbbf24; } /* å‘¨æœ«é»„è‰² */
        .d-date { font-size: 13px; font-weight: bold; color: var(--text-main); line-height: 1.1; }
        .d-week { font-size: 10px; color: var(--text-sub); line-height: 1.1; }
        .date-chip.active .d-date { color: var(--text-accent); }

        .grid-intraday { display: grid; grid-template-columns: 3fr 1fr; grid-template-rows: 1fr 200px; gap: 15px; padding: 15px; flex: 1; min-height: 0; }
        .layout-trend { display: flex; flex-direction: column; gap: 15px; padding: 15px; height: 100%; box-sizing: border-box; }
        .trend-chart-box { flex: 3; min-height: 400px; display: flex; flex-direction: column; }
        .trend-table-box { flex: 2; min-height: 0; display: flex; flex-direction: column; }

        /* é¢æ¿ */
        .panel { background: var(--bg-panel); border: 1px solid var(--border-color); border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; position: relative; width: 100%; height: 100%; box-shadow: var(--shadow); }
        .panel-header { height: 40px; min-height: 40px; padding: 0 15px; background: var(--bg-element); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-size: 13px; font-weight: bold; color: var(--text-sub); flex-shrink: 0; }
        
        /* æ§ä»¶ */
        .compare-select { background: var(--bg-panel); color: var(--text-accent); border: 1px solid var(--border-color); border-radius: 4px; padding: 3px 8px; font-size: 12px; outline: none; cursor: pointer; font-weight: bold; }
        .table-filters { display: flex; gap: 10px; align-items: center; }
        .tf-select { background: var(--bg-panel); color: var(--text-main); border: 1px solid var(--border-color); border-radius: 4px; padding: 3px 8px; font-size: 12px; outline: none; cursor: pointer; }
        .tf-hint { font-size: 12px; color: var(--text-sub); margin-right: 5px; }
        
        .legend-bar { height: 45px; min-height: 45px; border-top: 1px solid var(--border-color); background: var(--bg-element); display: flex; align-items: center; padding: 0 15px; gap: 10px; overflow-x: auto; flex-shrink: 0; }
        .legend-btn { font-size: 12px; padding: 5px 12px; border-radius: 20px; cursor: pointer; border: 1px solid var(--border-color); color: var(--text-sub); background: var(--bg-panel); white-space: nowrap; display: flex; align-items: center; gap: 6px; user-select: none; transition: all 0.2s; }
        .legend-btn:hover { border-color: var(--text-sub); }
        .legend-btn.active { color: #fff; font-weight: bold; border-color: transparent; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .legend-dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; }
        .action-btn { background: var(--bg-element); color: var(--text-main); border: 1px solid var(--border-color); }
        .action-btn:hover { background: var(--border-color); }

        /* å†…å®¹ */
        .scroll-list { overflow-y: auto; flex: 1; }
        .trend-table { width: 100%; border-collapse: collapse; font-size: 12px; font-family: 'Consolas', monospace; text-align: left; }
        .trend-table th { background: var(--bg-element); padding: 10px; color: var(--text-sub); position: sticky; top: 0; font-weight: 600; }
        .trend-table td { border-bottom: 1px solid var(--border-color); padding: 8px 10px; color: var(--text-main); }
        .trend-table tr:hover { background: var(--bg-element); }
        
        .market-summary { padding: 15px; background: var(--bg-element); border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .sum-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; color: var(--text-sub); }
        .sum-val { font-weight: bold; color: var(--text-main); }
        .trend-bar { height: 8px; background: var(--border-color); border-radius: 4px; margin-top: 12px; display: flex; overflow: hidden; }
        .bar-segment { height: 100%; transition: width 0.5s; }
        
        .list-item { display: flex; justify-content: space-between; padding: 10px 15px; border-bottom: 1px solid var(--border-color); font-size: 13px; color: var(--text-main); align-items: center; }
        .list-item:hover { background: var(--bg-element); }
        .list-item.my { background: rgba(59, 130, 246, 0.1); border-left: 3px solid var(--text-accent); }
        .trend-up { color: #ef4444; } .trend-down { color: #10b981; } /* çº¢æ¶¨ç»¿è·Œ */
        
        .log-item { padding: 8px 15px; border-bottom: 1px dashed var(--border-color); font-size: 12px; color: var(--text-sub); display: flex; align-items: center; }
        .tag { padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-right: 8px; font-weight: bold; color: #fff; }
        .tag-red { background: #ef4444; } .tag-green { background: #10b981; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-sub); }
    </style>
</head>
<body>
    <div class="nav-bar">
        <div class="nav-left">
            <div class="app-title"><div class="live-dot"></div> æŒ‡æŒ¥ä¸­å¿ƒ V23.0</div>
            <div class="view-tabs">
                <div class="view-tab active" onclick="switchView('intraday', this)">ğŸ”´ å…¥ä½æ—¥è¿½è¸ª</div>
                <div class="view-tab" onclick="switchView('trend', this)">ğŸ“… è¿œæœŸå¤§ç›˜</div>
            </div>
        </div>
        <select class="bed-select" id="bed-select" onchange="refreshGlobal()">
            <option value="big">ğŸ›ï¸ å¤§åºŠæˆ¿</option>
            <option value="twin">ğŸ›ï¸ åŒåºŠæˆ¿</option>
        </select>
    </div>

    <div class="main-content">
        <div id="view-intraday" class="view-layer active">
            <div class="date-ribbon-wrapper"><div class="date-scroll" id="date-ribbon"></div></div>
            <div class="grid-intraday">
                <div class="panel" style="grid-column: 1/2; grid-row: 1/2;">
                    <div class="panel-header"><span id="chart-title-intraday">å…¥ä½æ—¥ä»·æ ¼æ¼”å˜ (å…¨å‘¨æœŸ)</span></div>
                    <div style="flex:1; width:100%; position:relative;"><div id="chart-intraday" style="position:absolute; width:100%; height:100%;"></div></div>
                    <div class="legend-bar" id="legend-intraday"></div>
                </div>
                <div class="panel" style="grid-column: 2/3; grid-row: 1/3;">
                    <div class="panel-header">
                        <span>å¤§ç›˜æ™´é›¨è¡¨</span>
                        <select id="compare-mode" class="compare-select" onchange="renderBarometer()">
                            <option value="yesterday">VS æ˜¨æ—¥æ”¶ç›˜</option>
                            <option value="today_open">VS ä»Šæ—¥å¼€ç›˜</option>
                            <option value="last_capture">VS ä¸Šæ¬¡é‡‡é›†</option>
                        </select>
                    </div>
                    <div class="market-summary" id="market-barometer"></div>
                    <div class="scroll-list" id="rank-list"></div>
                </div>
                <div class="panel" style="grid-column: 1/2; grid-row: 2/3;">
                    <div class="panel-header">å†å²å¼‚åŠ¨è®°å½•</div>
                    <div class="scroll-list" id="log-list"></div>
                </div>
            </div>
        </div>
        <div id="view-trend" class="view-layer">
            <div class="layout-trend">
                <div class="panel trend-chart-box">
                    <div class="panel-header"><span id="trend-title">æœªæ¥ä»·æ ¼å¤§ç›˜</span></div>
                    <div style="flex:1; width:100%; position:relative; min-height: 400px;"><div id="chart-trend" style="position:absolute; width:100%; height:100%;"></div></div>
                    <div class="legend-bar" id="legend-trend"></div>
                </div>
                <div class="panel trend-table-box">
                    <div class="panel-header">
                        <span>ä»·æ ¼æ˜ç»†è¡¨ (é…’åº—ç­›é€‰è¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®)</span>
                        <div class="table-filters"><span class="tf-hint">æ—¥æœŸè¿‡æ»¤:</span><select id="tf-date" class="tf-select" onchange="renderTrendTable()"><option value="all">ğŸ“… å…¨éƒ¨æ—¥æœŸ</option></select></div>
                    </div>
                    <div class="scroll-list">
                        <table class="trend-table" id="trend-table"><thead><tr><th>æ—¥æœŸ</th><th>é…’åº—</th><th>å½“å‰ä»·</th><th>å†å²ä½</th><th>å†å²é«˜</th><th>å‡ä»·</th></tr></thead><tbody></tbody></table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        var REAL_DB = window.HOTEL_DATABASE || null; 
        if(!REAL_DB) { console.warn("æœªæ£€æµ‹åˆ° data.jsï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®"); REAL_DB = generateMockData(); }

        var hotels = REAL_DB.hotels;
        var myHotelName = REAL_DB.myHotel;
        var dateMeta = REAL_DB.dateMeta;
        var db = REAL_DB.db;
        var globalLogs = REAL_DB.logs;

        // é¢œè‰²ç”Ÿæˆç®—æ³•
        function getHotelColor(index) { var hue = (index * 137.508) % 360; return `hsl(${hue}, 70%, 55%)`; } // ç¨å¾®é™ä½äº®åº¦é€‚é…ç™½åº•

        var state = { view: 'intraday', bed: 'big', date: dateMeta[0].full, selectedHotels: [...hotels] };
        var chartIntraday, chartTrend;
        var isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

        // ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            isDark = event.matches;
            refreshAll(); // é‡ç»˜å›¾è¡¨ä»¥æ›´æ–°é¢œè‰²
        });

        // è·å–å½“å‰ä¸»é¢˜ä¸‹çš„å›¾è¡¨é¢œè‰²é…ç½®
        function getChartTheme() {
            return {
                splitLine: isDark ? '#2d3748' : '#e5e7eb',
                axisLabel: isDark ? '#94a3b8' : '#6b7280',
                zoomBorder: isDark ? '#4b5563' : '#d1d5db',
                zoomFill: isDark ? 'rgba(96, 165, 250, 0.2)' : 'rgba(59, 130, 246, 0.1)',
                tooltipBg: isDark ? 'rgba(27, 33, 45, 0.95)' : 'rgba(255, 255, 255, 0.95)',
                tooltipText: isDark ? '#e2e8f0' : '#1f2937',
                tooltipBorder: isDark ? '#4b5563' : '#e5e7eb'
            };
        }

        function generateMockData() {
            var _hotels = ['äº¿é“‚é…’åº—', 'Sproutæ‚¦é›…', 'å¯Œç±³æ±Ÿæ™¯', 'Lé…’åº—', 'æµ·ä¹‹ç ', 'å¤ç™»ä¸´', 'Palm Music', 'æ–°å¢å¸Œå°”é¡¿']; 
            var _start = new Date('2026-02-16');
            var _days = 35;
            var _weeks = ['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'];
            var _meta = [], _db = {}, _logs = [];
            var todayTs = new Date('2026-01-28T09:00:00').getTime();

            for(let i=0; i<_days; i++) {
                let checkInDate = new Date(_start); checkInDate.setDate(checkInDate.getDate()+i);
                let ds = checkInDate.toISOString().split('T')[0];
                let isW = (checkInDate.getDay()===5||checkInDate.getDay()===6);
                _meta.push({full:ds, short:ds.slice(5), week:_weeks[checkInDate.getDay()], isWeekend:isW});
                _db[ds] = {'big':{}, 'twin':{}};
                ['big','twin'].forEach(bed => {
                    _hotels.forEach((h, idx) => {
                        let base = 300+(idx*20)+(isW?100:0)+(bed==='twin'?50:0);
                        let pts = [];
                        var scrapeCount = 960; 
                        var currentPrice = base;
                        var yesterdayClose = base; 
                        var todayOpen = base; 

                        for(let k=0; k<scrapeCount; k++) {
                            let scrapeTime = todayTs - ( (scrapeCount - k) * 30 * 60 * 1000 );
                            let change = (Math.random()*20 - 10);
                            if(Math.random() > 0.99) change *= 3; 
                            currentPrice += change;
                            let val = Math.round(currentPrice);
                            if(k % 5 === 0) pts.push([scrapeTime, val]); 
                            if (k === scrapeCount - 48) yesterdayClose = val;
                            if (k === scrapeCount - 24) todayOpen = val;
                            if(Math.abs(change)>15 && k > scrapeCount - 50) {
                                _logs.push({ date: ds, time: new Date(scrapeTime).toLocaleDateString() + ' ' + new Date(scrapeTime).getHours() + ':00', hotel: h, bed: bed, type: change>0?'up':'down', val:val });
                            }
                        }
                        let vals = pts.map(p=>p[1]);
                        _db[ds][bed][h] = { 
                            points: pts, yesterday: yesterdayClose, todayOpen: todayOpen, lastCapture: vals.length > 1 ? vals[vals.length-2] : vals[0],
                            current: vals[vals.length-1], min:Math.min(...vals), max:Math.max(...vals), avg:Math.round(vals.reduce((a,b)=>a+b,0)/vals.length) 
                        };
                    });
                });
            }
            return { hotels: _hotels, myHotel: 'äº¿é“‚é…’åº—', dateMeta: _meta, db: _db, logs: _logs };
        }

        function initUI() {
            var ribbon = document.getElementById('date-ribbon');
            var tfDate = document.getElementById('tf-date');
            ribbon.innerHTML = '';
            dateMeta.forEach(d => {
                var el = document.createElement('div');
                el.className = `date-chip ${d.isWeekend?'weekend':''}`;
                el.id = `chip-${d.full}`;
                el.innerHTML = `<div class="d-date">${d.short}</div><div class="d-week">${d.week}</div>`;
                el.onclick = () => switchDate(d.full);
                ribbon.appendChild(el);
                var opt = document.createElement('option'); opt.value = d.full; opt.text = `${d.short} (${d.week})`; tfDate.appendChild(opt);
            });

            renderCustomLegend('legend-intraday'); renderCustomLegend('legend-trend');
            chartIntraday = echarts.init(document.getElementById('chart-intraday'));
            chartTrend = echarts.init(document.getElementById('chart-trend'));
            
            const ro = new ResizeObserver(() => { chartIntraday.resize(); chartTrend.resize(); });
            ro.observe(document.querySelector('.main-content'));

            switchDate(state.date);
            updateTrendTitle();
            refreshAll();
        }

        function updateTrendTitle() { document.getElementById('trend-title').innerText = `æœªæ¥ä»·æ ¼å¤§ç›˜ (${dateMeta[0].full} è‡³ ${dateMeta[dateMeta.length-1].full})`; }
        
        function renderCustomLegend(cid) {
            var c = document.getElementById(cid);
            var html = `<div class="legend-btn action-btn" onclick="toggleAll(true)">å…¨é€‰</div><div class="legend-btn action-btn" onclick="toggleAll(false)">å…¨ä¸é€‰</div><div style="width:1px; height:20px; background:var(--border-color); margin:0 5px;"></div>`;
            hotels.forEach((h, idx) => {
                var col = getHotelColor(idx);
                var act = state.selectedHotels.includes(h);
                // é€‚é…ä¸»é¢˜é¢œè‰²
                var btnStyle = act ? `background:${col};color:#fff;border-color:${col}` : '';
                var dotStyle = act ? `background:#fff` : `background:${col}`;
                html += `<div class="legend-btn ${act?'active':''}" style="${btnStyle}" onclick="toggleHotel('${h}')"><div class="legend-dot" style="${dotStyle}"></div>${h}</div>`;
            });
            c.innerHTML = html;
        }
        function toggleHotel(n) { state.selectedHotels.includes(n)?state.selectedHotels=state.selectedHotels.filter(h=>h!==n):state.selectedHotels.push(n); refreshAll(); }
        function toggleAll(chk) { state.selectedHotels = chk?[...hotels]:[]; refreshAll(); }
        function switchView(v, el) {
            state.view = v;
            document.querySelectorAll('.view-tab').forEach(t=>t.classList.remove('active')); el.classList.add('active');
            document.querySelectorAll('.view-layer').forEach(c=>c.classList.remove('active')); document.getElementById('view-'+v).classList.add('active');
            setTimeout(()=>{chartIntraday.resize();chartTrend.resize(); renderTrendChart();}, 50);
        }
        function switchDate(d) {
            state.date = d;
            document.querySelectorAll('.date-chip').forEach(c=>c.classList.remove('active'));
            var act = document.getElementById(`chip-${d}`); if(act) { act.classList.add('active'); act.scrollIntoView({behavior:"smooth",inline:"center"}); }
            refreshAll();
        }
        function refreshGlobal() { state.bed = document.getElementById('bed-select').value; refreshAll(); }
        function refreshAll() {
            renderCustomLegend('legend-intraday'); renderCustomLegend('legend-trend');
            renderIntradayChart(); renderBarometer(); renderLogs(); renderTrendChart(); renderTrendTable();
        }

        function renderIntradayChart() {
            var theme = getChartTheme();
            var series = [];
            state.selectedHotels.forEach(h => {
                var hIdx = hotels.indexOf(h); var isMy = h===myHotelName; var col = getHotelColor(hIdx);
                series.push({ name: h, type: 'line', data: db[state.date][state.bed][h].points, smooth: true, symbol: 'none', itemStyle: { color: col }, lineStyle: { width: isMy?3:1.5 }, z: isMy?10:2 });
            });
            chartIntraday.setOption({
                backgroundColor: 'transparent', legend: { show: false }, 
                tooltip: { trigger: 'axis', backgroundColor: theme.tooltipBg, borderColor: theme.tooltipBorder, textStyle: { color: theme.tooltipText } },
                grid: { left:'2%', right:'4%', top:'10%', bottom:'15%', containLabel:true },
                dataZoom: [ { type: 'slider', show: true, xAxisIndex: [0], start: 80, end: 100, height: 20, bottom: 5, borderColor: theme.zoomBorder, fillerColor: theme.zoomFill, handleStyle: {color:'#3b82f6'} }, { type: 'inside', xAxisIndex: [0] } ],
                xAxis: { 
                    type:'time', 
                    splitLine:{show:true, lineStyle:{color: theme.splitLine, type:'dashed'}}, 
                    axisLabel:{ color: theme.axisLabel, formatter: '{MM}-{dd}\n{HH}:{mm}', hideOverlap: true } 
                },
                yAxis: { type:'value', scale:true, splitLine:{lineStyle:{color: theme.splitLine}}, axisLabel:{color: theme.axisLabel} },
                series: series
            }, true);
            document.getElementById('chart-title-intraday').innerText = `å…¥ä½æ—¥ ${state.date} çš„å†å²ä»·æ ¼æ¼”å˜`;
        }

        function renderTrendChart() {
            var theme = getChartTheme();
            var series = [];
            state.selectedHotels.forEach(h => {
                var hIdx = hotels.indexOf(h); var isMy = h===myHotelName; var col = getHotelColor(hIdx);
                var data = dateMeta.map(d => db[d.full][state.bed][h].current);
                series.push({ name: h, type: 'line', data: data, smooth: true, symbolSize: 6, itemStyle: { color: col }, lineStyle: { width: isMy?3:1.5 } });
            });
            chartTrend.setOption({
                backgroundColor: 'transparent', legend: { show: false }, 
                tooltip: { trigger: 'axis', backgroundColor: theme.tooltipBg, borderColor: theme.tooltipBorder, textStyle: { color: theme.tooltipText } },
                grid: { left:'2%', right:'3%', top:'10%', bottom:'5%', containLabel:true },
                xAxis: { type:'category', data: dateMeta.map(d=>d.short), axisLabel: { color: theme.axisLabel } },
                yAxis: { type:'value', scale:true, splitLine:{lineStyle:{color: theme.splitLine}}, axisLabel:{color: theme.axisLabel} },
                series: series
            }, true);
        }

        function renderTrendTable() {
            var html = ''; var fDate = document.getElementById('tf-date').value;
            var tDates = (fDate === 'all') ? dateMeta : dateMeta.filter(d => d.full === fDate);
            if(state.selectedHotels.length===0) { document.querySelector('#trend-table tbody').innerHTML='<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--text-sub)">è¯·åœ¨ä¸Šæ–¹å‹¾é€‰è‡³å°‘ä¸€å®¶é…’åº—</td></tr>'; return; }
            tDates.forEach(d => {
                state.selectedHotels.forEach(h => {
                    var info = db[d.full][state.bed][h];
                    var isMy = h===myHotelName;
                    html += `<tr><td>${d.short}</td><td style="color:${isMy?'var(--text-accent)':'var(--text-sub)'};font-weight:${isMy?'bold':'normal'}">${h}</td><td style="font-weight:bold">Â¥${info.current}</td><td style="color:#10b981">Â¥${info.min}</td><td style="color:#ef4444">Â¥${info.max}</td><td>Â¥${info.avg}</td></tr>`;
                });
            });
            document.querySelector('#trend-table tbody').innerHTML = html;
        }

        function renderBarometer() {
            var todayData = db[state.date][state.bed];
            var up=0, down=0, flat=0, total=0, count=0, list=[];
            var mode = document.getElementById('compare-mode').value; 
            
            state.selectedHotels.forEach(h => {
                var info = todayData[h];
                total += info.current; count++;
                var refPrice;
                if(mode === 'yesterday') refPrice = info.yesterday;
                else if(mode === 'today_open') refPrice = info.todayOpen;
                else refPrice = info.lastCapture;
                var diff = info.current - refPrice;
                if(diff > 0) up++; else if(diff < 0) down++; else flat++;
                list.push({name:h, p:info.current, d:diff});
            });

            var avg = count ? Math.round(total/count) : 0;
            var totalCount = up+down+flat;
            var upPct = totalCount ? (up/totalCount)*100 : 0;
            var downPct = totalCount ? (down/totalCount)*100 : 0;
            var flatPct = totalCount ? (flat/totalCount)*100 : 0;

            document.getElementById('market-barometer').innerHTML = `<div class="sum-row"><span>å¸‚åœºå‡ä»·</span> <span class="sum-val">Â¥${avg}</span></div><div class="sum-row"><span>æ¶¨ / è·Œ (å®¶)</span> <span class="sum-val"><span class="trend-up">${up}</span> / <span class="trend-down">${down}</span></span></div><div class="trend-bar"><div class="bar-segment" style="width:${upPct}%; background:#ef4444"></div><div class="bar-segment" style="width:${flatPct}%; background:#6b7280"></div><div class="bar-segment" style="width:${downPct}%; background:#10b981"></div></div>`;

            var lh = ''; list.sort((a,b)=>a.p-b.p);
            list.forEach(i=>{
                var isMy=i.name===myHotelName; var diffStr = i.d>0?`â–²+${i.d}`:(i.d<0?`â–¼${i.d}`:'-'); var cls = i.d>0?'trend-up':(i.d<0?'trend-down':'');
                lh += `<div class="list-item ${isMy?'my':''}"><div style="font-weight:${isMy?'bold':'normal'};color:${isMy?'var(--text-accent)':'var(--text-sub)'}">${i.name}</div><div style="text-align:right"><div style="font-weight:bold;font-family:Consolas">Â¥${i.p}</div><div class="${cls}" style="font-size:11px">${diffStr}</div></div></div>`;
            });
            document.getElementById('rank-list').innerHTML = lh;
        }

        function renderLogs() {
            var logs = globalLogs.filter(l=>l.date===state.date && l.bed===state.bed && state.selectedHotels.includes(l.hotel));
            logs.sort((a,b)=>(new Date(a.time) < new Date(b.time) ? 1 : -1));
            var h=''; logs.forEach(l=>{
                var tag=l.type==='up'?'<span class="tag tag-red">æ¶¨</span>':'<span class="tag tag-green">è·Œ</span>';
                h+=`<div class="log-item"><span style="color:var(--text-sub);margin-right:10px;">${l.time}</span>${tag}<span style="color:var(--text-main);margin-right:5px;">${l.hotel}</span><span>${l.type==='up'?'ä¸Šè°ƒ':'ä¸‹è°ƒ'}è‡³ Â¥${l.val}</span></div>`;
            });
            document.getElementById('log-list').innerHTML = h||'<div style="padding:20px;text-align:center;color:var(--text-sub)">å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ— å¼‚åŠ¨</div>';
        }

        initUI();
    </script>
</body>
</html>